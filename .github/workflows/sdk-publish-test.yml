name: Publish Python SDK to TestPyPI

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    name: Publish to TestPyPI
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Gate (dev-only tags)
        id: gate
        run: |
          set -euo pipefail
          git fetch origin main dev --tags --force

          if git merge-base --is-ancestor "$GITHUB_SHA" "origin/dev"; then
            if git merge-base --is-ancestor "$GITHUB_SHA" "origin/main"; then
              echo "Tag commit is already on main; skipping TestPyPI publish."
              echo "publish=false" >> "$GITHUB_OUTPUT"
            else
              echo "publish=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "Tag commit is not on dev; skipping TestPyPI publish."
            echo "publish=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure tag matches project version
        if: steps.gate.outputs.publish == 'true'
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          python - << 'PY'
          import os
          import tomllib
          from pathlib import Path
          
          tag = os.environ["TAG_NAME"]
          data = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          version = data["project"]["version"]
          expected = f"v{version}"
          if tag != expected:
            raise SystemExit(f"Tag '{tag}' does not match pyproject.toml version '{version}' (expected '{expected}').")
          print(f"OK: {tag} == {expected}")
          PY

      - name: Build package
        if: steps.gate.outputs.publish == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine
          python -m build
          twine check dist/*

      - name: Publish to TestPyPI
        if: steps.gate.outputs.publish == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          twine upload --repository-url https://test.pypi.org/legacy/ dist/*

